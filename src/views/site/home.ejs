<%- include('../partials/head.ejs') %>
    <script src="/js/jquery.js"></script>
    </head>

    <body>
        <header class="scroll" style="position: fixed;">
            <div class="logo"><a href="/">LazaPee</a></div>
            <nav>
                <div class="hello">Hello</div>

                <div class="products">
                    Danh mục
                    <ul>
                        <li><a href="">Giày</a></li>
                        <li><a href="">Quần áo</a></li>
                        <li><a href="">Phụ kiện</a></li>
                        <li><a href="">Khác</a></li>
                    </ul>
                </div>
                <div class="my-shop">
                    Cửa hàng
                    <ul>
                        <li><a href="">Đơn đặt hàng</a></li>
                        <li><a href="/my/store/product">Kho</a></li>
                        <li><a href="">Mã giảm giá</a></li>
                        <li><a href="/my/store/product/post">Đăng sản phẩm</a></li>
                    </ul>
                </div>
                <div class="my-self">
                    Tài khoản
                    <ul>
                        <li><a href="">Đơn hàng đã đặt</a></li>
                        <li><a href="">Địa chỉ nhận hàng</a></li>
                        <li><a href="">Thông tin cá nhân</a></li>
                        <li><a href="">Đổi mật khẩu</a></li>
                    </ul>
                </div>

                <div id="cart">
                    <i class="fa-solid fa-cart-arrow-down"></i>
                </div>

                <a href="" id="login-out">
                    <button>Đăng xuất</button>
                </a>
            </nav>
        </header>


        <div id="banner">
            <div>MUA và BÁN</div>
            <div class="bg">MỌI THỨ, NGAY BÂY GIỜ</div><br>
            <div class="search">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Tìm kiếm..." id="search-input" class="search-input">
            </div>
            <div id="search-value">
            </div>
        </div>

        <main id="main">
            <div class="container">
                <div class="header">
                    <select class="form-select" id="select-options">jj
                        <option value="all">All</option>
                        <option value="shoes">Giày</option>
                        <option value="clothes">Quần áo</option>
                        <option value="accessory">Phụ kiện</option>
                        <option value="other">Khác</option>
                    </select>

                    <select class="form-select" id="sort-products">
                        <option value="new">Mới - cũ</option>
                        <option value="old">Cũ - mới</option>
                        <option value="asc">Giá thấp - cao</option>
                        <option value="desc">Giá cao - thấp</option>
                    </select>
                </div>

                <div class="content-list-product" id="content-list-product">
                    <% products.forEach(item=> { %>
                        <div class="product-item">
                            <a href="/product/details/<%= item.slug %>">
                                <div class="product-img">
                                    <img src="<%= item.coverImg %>" alt="">
                                </div>
                                <div class="product-content">
                                    <div class="product-name">
                                        <%= item.productName %>
                                    </div>
                                    <div class="product-price"
                                        data-price="<%= item.price * ( 100 - item.discount) / 100 %>"></div>
                                </div>
                            </a>
                        </div>
                        <% }) %>
                </div>
            </div>
            <div class="load-page">
                <button id="load-page">
                    Xem thêm sản phẩm
                </button>
            </div>
        </main>

        <%- include('../partials/footer.ejs') %>
            <script>
                // convertPrice
                function convertPrice(cls, atr) {
                    const prices = document.querySelectorAll(cls)
                    prices.forEach(e => {
                        e.innerText = (e.getAttribute(atr) - 0).toLocaleString() + ' đ'
                    })
                }
                convertPrice('.product-price', 'data-price')


                // header
                const header = document.querySelector('header')
                window.addEventListener('scroll', e => {
                    if (window.scrollY < 300) {
                        header.classList.add('scroll')
                    } else {
                        header.classList.remove('scroll')
                    }
                })


                // search
                const input = document.querySelector('#search-input')
                const searchValue = document.querySelector('#search-value')
                window.onclick = (e) => {
                    if (e.target.classList.contains('search-input') || e.target.classList.contains('search-link')) {
                        searchValue.classList.add('active')
                    } else {
                        searchValue.classList.remove('active')
                    }
                }

                input.onkeyup = () => {
                    let text = input.value
                    if (text != '') {
                        $.ajax({
                            url: '/search-products',
                            type: 'POST',
                            data: { text },
                            success: (data) => {
                                let products = data.products
                                if (products.length > 0) {
                                    const html = products.reduce((acc, product) => {
                                        acc.push(`
                                            <div class="search-item">
                                                <a href="/product/details/${product.slug}">
                                                    <div class="search-img">
                                                        <img src="${product.coverImg}" alt="" class="search-link">
                                                    </div>
                                                    <div class="search-content">
                                                        <p class="search-name search-link">
                                                            ${product.productName}
                                                        </p>
                                                        <p class="search-price search-link">
                                                            ${(product.price * (100 - product.discount) / 100).toLocaleString()} đ
                                                        </p>
                                                    </div>
                                                </a>
                                            </div>
                                        `)
                                        return acc
                                    }, []).join('')

                                    searchValue.innerHTML = html
                                } else {
                                    searchValue.innerHTML = '<div style="color: #000000; margin: auto; font-size: 20px">Không Tìm Thấy Sản Phẩm</div>'
                                }
                            },
                            error: (err) => {
                                console.log(err.message);
                            }
                        })
                    }
                }

                //filter products
                let pageIndex = 1
                let pageTotal = 2
                const options = document.querySelector('#select-options')
                const sort = document.querySelector('#sort-products')
                const selects = document.querySelectorAll('.form-select')
                const listProduct = document.getElementById('content-list-product')
                selects.forEach(select => {
                    select.onchange = async (e) => {
                        let products = null
                        await $.ajax({
                            url: '/filter-products',
                            type: 'POST',
                            data: {
                                options: options.value,
                                sort: sort.value,
                                pageIndex: 0
                            },
                            success: (data) => {
                                products = data.products
                                pageTotal = data.pageTotal
                                pageIndex = 1
                            },
                            error: (err) => {
                                console.log(err.message);
                            }
                        })

                        const html = products.reduce((acc, product) => {
                            acc.push(`
                                <div class="product-item">
                                    <a href="/product/details/${product.slug}">
                                        <div class="product-img">
                                            <img src="${product.coverImg}" alt="">
                                        </div>
                                        <div class="product-content">
                                            <div class="product-name">
                                                ${product.productName}
                                            </div>
                                            <div class="product-price">
                                                ${(product.price * (100 - product.discount) / 100).toLocaleString()} đ
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            `)
                            return acc
                        }, []).join('')

                        listProduct.innerHTML = html
                        if (pageTotal == pageIndex) {
                            document.getElementById('load-page').style.display = 'none'
                        } else {
                            document.getElementById('load-page').style.display = 'inline-block'
                        }
                    }
                })

                // load products
                const btnLoadPage = document.querySelector('#load-page')
                btnLoadPage.onclick = async () => {
                    if (pageTotal > pageIndex) {
                        let loadProducts = null
                        await $.ajax({
                            url: '/filter-products',
                            type: 'POST',
                            data: {
                                options: options.value,
                                sort: sort.value,
                                pageIndex
                            },
                            success: (data) => {
                                loadProducts = data.products
                                pageTotal = data.pageTotal
                                pageIndex++
                            },
                            error: (err) => {
                                console.log(err.message);
                            }
                        })

                        loadProducts.forEach(product => {
                            const html = `
                                <a href="/product/details/${product.slug}">
                                    <div class="product-img">
                                        <img src="${product.coverImg}" alt="">
                                    </div>
                                    <div class="product-content">
                                        <div class="product-name">
                                            ${product.productName}
                                        </div>
                                        <div class="product-price">
                                            ${(product.price * (100 - product.discount) / 100).toLocaleString()} đ
                                        </div>
                                    </div>
                                </a>
                            `
                            let div = document.createElement('div')
                            div.innerHTML = html
                            div.classList.add('product-item')
                            listProduct.appendChild(div)
                        })
                    }
                    if (pageTotal == pageIndex) {
                        document.getElementById('load-page').style.display = 'none'
                    }
                }

            </script>